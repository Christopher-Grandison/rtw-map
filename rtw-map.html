<!DOCTYPE html>
<html>
<head>
	<title>Right-to-work</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
	<style>
		html, body, #map {
			height: 100%;
			padding: 0;
			margin: 0;
		}
		#layer_selector {
			position: absolute;
			top: 20px;
			right: 100px;
			padding: 0;
		}
		#layer_selector h5 {
			font-family: "Helvetica", Arial;
			padding: 3px 0px;
			text-align: center;
		}
		#layer_selector ul {
			padding: 0; margin: 0;
			list-style-type: none;
		}
		#layer_selector li {
			border-bottom: 1px solid #999;
			padding: 15px 30px;
			font-family: "Helvetica", Arial;
			font-size: 13px;
			color: #444;
			cursor: auto;
		}
		#layer_selector li:hover {
			background-color: #F0F0F0;
			cursor: pointer;
		}
		#layer_selector li.selected {
			background-color: #EEE;
		}

	</style>

	<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
</head>
<body>
	<div id="map"></div>
	<div id="layer_selector" class="cartodb-infobox">
		<h5>PERCENT UNINSURED</h5>
		<ul>
			<li data="all" class="uninsured-rate">All states</li>
			<li data="<= 0.13" class="uninsured-rate">13% or less uninsured</li>
			<li data="> 0.13" class="uninsured-rate">more than 13% uninsured</li>
		</ul>
		<h5>PERCENT UNIONIZED</h5>
		<ul>
			<li data="all">All states</li>
			<li data="<= 0.1" class="unionized-rate">10% or less unionized</li>
			<li data="> 0.1" class="unionized-rate">more than 10% unionized</li>
		</ul>
		<h5>PERCENT POVERTY</h5>
		<ul>
			<li data="all">All states</li>
			<li data="<= 0.15" class="poverty-rate">15% or fewer residents in poverty"</li>
			<li data="> 0.15" class="poverty-rate">more than 15% residents in poverty</li>
		</ul>
		<hr>
		<hr>
		
		<ul>
			<li>RESET</li>
			</ul>
	</div>
</body>

<!-- include cartodb.js library -->
<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

<script>
	function createSelector(layer) {
		var sql = new cartodb.SQL({ user: 'fma2' });
		var $options = $('#layer_selector li.uninsured-rate');
		$options.click(function(e) {
	      // get the area of the selected layer
	      var $li = $(e.target);
	      var ineq = $li.attr('data');
	      // deselect all and select the clicked one
	      $options.removeClass('selected');
	      $li.addClass('selected');
	      // create query based on data from the layer
	      var query = "select * from us_states_no_ak_hi_rtw_insured_rate";
	      if(ineq !== 'all') {
	      	query = "select * from us_states_no_ak_hi_rtw_insured_rate where uninsured_rate___percent" + ineq;
	      }

	      layer.on('featureOver', function(e, latlng, pos, data) {
	      	console.log(e)  	
	      });
	      // change the query in the layer to update the map
	      layer.setSQL(query);
	      layer.setCartoCSS(
	      	'#us_states_no_ak_hi_rtw_insured_rate {marker-placement:interior;  marker-fill: white; marker-allow-overlap:false; marker-multi-policy: whole; line-color: rgba(0,0,0,1); }'
	      	);
	    });
	}

	function main() {
		cartodb.createVis('map', 'https://fma2.cartodb.com/api/v2/viz/509bcd20-f503-11e5-a235-0ea31932ec1d/viz.json', 
		{
			shareable: true,
        // title: true,
        // description: true,
        // search: true,
        tiles_loader: true,
        // center_lat: 0,
        // center_lon: 0,
        zoom: 3
      })
		.done(function(vis, layers) {
        // layer 0 is the base layer, layer 1 is cartodb layer
        // setInteraction is disabled by default
        // layers[1].setInteraction(true);
        // layers[1].on('featureOver', function(e, latlng, pos, data) {
        // 	cartodb.log.log(e, latlng, pos, data);
        // });
        
        // you can get the native map to work with it
        var map = vis.getNativeMap();
        
        // create a layer with 1 sublayer
        cartodb.createLayer(map, {
        	user_name: 'fma2',
        	type: 'cartodb',
        	sublayers: [{
        		sql: "SELECT * FROM us_states_no_ak_hi_rtw_insured_rate",
        	}],
        })
				.addTo(map) // add the layer to our map which already contains 1 sublayer
				.done(function(layer) {
					var subLayer = layer.getSubLayer(0);

					cartodb.vis.Vis.addInfowindow(map, layer, ['name','uninsured_rate___percent']);

					// cartodb.vis.Vis.addInfowindow(map, subLayer, ['name','uninsured_rate___percent'],{
					// 	infowindowTemplate: $('#infowindow_template').html(),
					// 	templateType: 'mustache'
					// });
					// layer.leafletMap.viz.addOverlay({
					// 	type: 'tooltip',
					// 	layer: subLayer,
					// 	template: '<div class="cartodb-tooltip-content-wrapper"><img style="width: 100%" src=>, , , </div>',
						// templateType: 'mustache',
						// position: 'bottom|right',
						// fields: [{ name: 'name' }]
					// });
					
					createSelector(subLayer);
				});  
			})
		.error(function(err) {
			console.log(err);
		});
	}
	window.onload = main;
</script>
</html>